<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SONGXS - Music Metadata Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .hero-text {
            font-size: clamp(3rem, 10vw, 8rem);
            font-weight: 900;
            letter-spacing: -0.02em;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 bg-black/80 backdrop-blur-sm border-b border-zinc-800">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="SONGXS Logo" class="h-10 object-contain">
            </a>
            <div class="flex gap-4 items-center">
                <a href="#extract" class="px-4 py-2 bg-zinc-800 text-white rounded hover:bg-zinc-700 transition">
                    Extract
                </a>
                <a href="#isrc" class="px-4 py-2 bg-zinc-800 text-white rounded hover:bg-zinc-700 transition">
                    ISRC
                </a>
                <a href="/catalog" class="px-4 py-2 bg-white text-black rounded hover:bg-zinc-200 transition">
                    My Catalog
                </a>
                {% if current_user.is_admin %}
                <a href="/admin" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                    üîë Admin
                </a>
                {% endif %}
                <span class="text-zinc-400 text-sm">|</span>
                <a href="/logout" class="text-zinc-400 hover:text-white transition text-sm">
                    Logout
                </a>
            </div>
        </nav>
    </header>

    <!-- Hero -->
    <section class="min-h-screen flex items-center justify-center pt-20">
        <h1 class="hero-text text-center">
            SONGXS
        </h1>
    </section>

    <!-- Extract from Playlist -->
    <section id="extract" class="min-h-screen bg-zinc-900 flex items-center justify-center px-6">
        <div class="max-w-2xl w-full">
            <h2 class="text-5xl font-bold mb-8">UPC/ISRC Extractor</h2>
            <p class="text-zinc-400 mb-8">Extract metadata from any Spotify playlist</p>
            
            <div class="space-y-4">
                <input 
                    type="text" 
                    id="playlistUrl" 
                    placeholder="Paste Spotify playlist URL"
                    class="w-full p-4 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-500 focus:border-white focus:outline-none"
                />
                
                <!-- Extraction Mode Selection -->
                <div class="bg-zinc-800 rounded-lg p-4">
                    <p class="text-sm text-zinc-400 mb-3">Extraction Mode:</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            id="fastModeBtn"
                            onclick="selectMode('fast')"
                            class="px-4 py-3 bg-green-600 text-white rounded-lg font-medium transition hover:bg-green-700"
                        >
                            ‚ö° Fast Mode
                            <p class="text-xs mt-1 opacity-80">~2-3 sec/track</p>
                        </button>
                        <button 
                            id="completeModeBtn"
                            onclick="selectMode('complete')"
                            class="px-4 py-3 bg-zinc-700 text-white rounded-lg font-medium transition hover:bg-zinc-600"
                        >
                            üîç Complete Mode
                            <p class="text-xs mt-1 opacity-80">~10-15 sec/track</p>
                        </button>
                    </div>
                    <div class="mt-3 text-xs text-zinc-500">
                        <p id="modeDescription">
                            <strong>Fast:</strong> Spotify data only (audio features, artist stats, images)<br>
                            <strong>Complete:</strong> All data (+ Last.fm, location, Instagram, TikTok)
                        </p>
                    </div>
                </div>
                
                <button 
                    onclick="extractFromPlaylist()"
                    class="w-full px-8 py-4 bg-white text-black font-bold rounded-lg hover:bg-zinc-200 transition"
                >
                    Extract Metadata
                </button>
            </div>

            <!-- Loading -->
            <div id="extractLoading" class="hidden mt-8 text-center">
                <div class="animate-pulse">
                    <p class="text-xl">‚è≥ Extracting metadata...</p>
                    <p class="text-zinc-400 mt-2">This may take a few seconds</p>
                </div>
            </div>

            <!-- Results -->
            <div id="extractResults" class="hidden mt-8 fade-in">
                <div class="bg-zinc-800 rounded-lg p-6">
                    <h3 class="text-2xl font-bold mb-4">‚úì Extraction Complete</h3>
                    <div class="space-y-2 text-zinc-300">
                        <p>Total tracks: <span id="totalTracks" class="text-white font-bold"></span></p>
                    </div>
                    <button 
                        onclick="downloadExcel()"
                        class="mt-6 w-full px-6 py-3 bg-zinc-700 rounded-lg hover:bg-zinc-600 transition"
                    >
                        üì• Download Excel
                    </button>
                </div>
            </div>

            <!-- Error -->
            <div id="extractError" class="hidden mt-8 fade-in">
                <div class="bg-red-900/20 border border-red-900 rounded-lg p-6">
                    <p class="text-red-400">‚ùå <span id="errorMessage"></span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- ISRC to Playlist -->
    <section id="isrc" class="min-h-screen bg-black flex items-center justify-center px-6">
        <div class="max-w-2xl w-full">
            <h2 class="text-5xl font-bold mb-8">ISRC to Playlist</h2>
            <p class="text-zinc-400 mb-8">Create a Spotify playlist from ISRC codes</p>
            
            <div class="space-y-4">
                <textarea 
                    id="isrcList" 
                    rows="10"
                    placeholder="Paste ISRCs (one per line)&#10;&#10;Example:&#10;USRC17607839&#10;GBUM71507847&#10;USSM12345678"
                    class="w-full p-4 bg-zinc-900 border border-zinc-800 rounded-lg text-white placeholder-zinc-500 focus:border-white focus:outline-none font-mono"
                ></textarea>
                
                <button 
                    onclick="createPlaylistFromISRCs()"
                    class="w-full px-8 py-4 bg-white text-black font-bold rounded-lg hover:bg-zinc-200 transition"
                >
                    Find Tracks
                </button>
            </div>

            <!-- Loading -->
            <div id="isrcLoading" class="hidden mt-8 text-center">
                <div class="animate-pulse">
                    <p class="text-xl">üîç Searching for tracks...</p>
                    <p class="text-zinc-400 mt-2">This may take a minute</p>
                </div>
            </div>

            <!-- Results -->
            <div id="isrcResults" class="hidden mt-8 fade-in">
                <div class="bg-zinc-900 rounded-lg p-6">
                    <h3 class="text-2xl font-bold mb-4">‚úì Search Complete</h3>
                    <div class="space-y-2 text-zinc-300">
                        <p>Tracks found: <span id="foundTracks" class="text-white font-bold"></span></p>
                        <p>Not found: <span id="notFoundTracks" class="text-red-400 font-bold"></span></p>
                    </div>
                    <div class="mt-6 space-y-2">
                        <button 
                            onclick="downloadISRCExcel()"
                            class="w-full px-6 py-3 bg-zinc-800 rounded-lg hover:bg-zinc-700 transition"
                        >
                            üì• Download Excel
                        </button>
                        <p class="text-center text-zinc-500 text-sm">
                            (Note: Creating Spotify playlist requires authentication)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="isrcError" class="hidden mt-8 fade-in">
                <div class="bg-red-900/20 border border-red-900 rounded-lg p-6">
                    <p class="text-red-400">‚ùå <span id="isrcErrorMessage"></span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="min-h-screen bg-zinc-900 flex items-center justify-center">
        <h2 class="hero-text text-zinc-800">
            SONGXS
        </h2>
    </footer>

    <script>
        let currentTracks = [];
        let selectedMode = 'fast'; // Default: Fast mode

        function selectMode(mode) {
            selectedMode = mode;
            
            // Update button styles
            const fastBtn = document.getElementById('fastModeBtn');
            const completeBtn = document.getElementById('completeModeBtn');
            
            if (mode === 'fast') {
                fastBtn.className = 'px-4 py-3 bg-green-600 text-white rounded-lg font-medium transition hover:bg-green-700';
                completeBtn.className = 'px-4 py-3 bg-zinc-700 text-white rounded-lg font-medium transition hover:bg-zinc-600';
            } else {
                fastBtn.className = 'px-4 py-3 bg-zinc-700 text-white rounded-lg font-medium transition hover:bg-zinc-600';
                completeBtn.className = 'px-4 py-3 bg-blue-600 text-white rounded-lg font-medium transition hover:bg-blue-700';
            }
        }

        async function extractFromPlaylist() {
            const url = document.getElementById('playlistUrl').value.trim();
            
            if (!url) {
                showError('extractError', 'errorMessage', 'Please paste a Spotify playlist URL');
                return;
            }

            // Hide previous results
            hideElement('extractResults');
            hideElement('extractError');
            showElement('extractLoading');

            try {
                const response = await fetch('/extract-from-playlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        playlist_url: url,
                        fetch_mode: selectedMode  // Include selected mode
                    })
                });

                const data = await response.json();

                hideElement('extractLoading');

                if (data.success) {
                    currentTracks = data.tracks;
                    document.getElementById('totalTracks').textContent = data.total_tracks;
                    showElement('extractResults');
                } else {
                    showError('extractError', 'errorMessage', data.error || 'Unknown error');
                }
            } catch (error) {
                hideElement('extractLoading');
                showError('extractError', 'errorMessage', 'Network error: ' + error.message);
            }
        }

        async function createPlaylistFromISRCs() {
            const isrcText = document.getElementById('isrcList').value.trim();
            
            if (!isrcText) {
                showError('isrcError', 'isrcErrorMessage', 'Please paste ISRC codes');
                return;
            }

            const isrcs = isrcText.split('\n').map(i => i.trim()).filter(i => i.length > 0);

            // Hide previous results
            hideElement('isrcResults');
            hideElement('isrcError');
            showElement('isrcLoading');

            try {
                const response = await fetch('/create-playlist-from-isrcs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isrcs: isrcs })
                });

                const data = await response.json();

                hideElement('isrcLoading');

                if (data.success) {
                    currentTracks = data.tracks;
                    document.getElementById('foundTracks').textContent = data.found;
                    document.getElementById('notFoundTracks').textContent = data.not_found;
                    showElement('isrcResults');
                } else {
                    showError('isrcError', 'isrcErrorMessage', data.error || 'Unknown error');
                }
            } catch (error) {
                hideElement('isrcLoading');
                showError('isrcError', 'isrcErrorMessage', 'Network error: ' + error.message);
            }
        }

        async function downloadExcel() {
            try {
                const response = await fetch('/download-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks: currentTracks })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `songxs_export_${Date.now()}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error downloading file');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function downloadISRCExcel() {
            await downloadExcel();
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showError(containerId, messageId, message) {
            document.getElementById(messageId).textContent = message;
            showElement(containerId);
        }
    </script>

</body>
</html>
